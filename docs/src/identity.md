# アイデンティティと検証

## did:webによる紐付け

polkaは、ドメイン名と公開鍵を紐付ける仕組みとして、did:webを採用しています。

### did:webとは

did:webは、W3Cが標準化したDecentralized Identifierの一種で、Webドメインを使ったDIDです。

`did:web:example.com` というDIDは、`https://example.com/.well-known/did.json` にあるDID Documentを指します。

DID Documentには、そのDIDに紐づく公開鍵とサービスエンドポイントが記載されています。

### 信頼の基盤

did:webは、既存のHTTPS/DNSインフラを信頼の基盤とします。

ドメインの真正性はHTTPS証明書により保証され、DID Documentの取得もHTTPS経由で行われます。これにより、新たな信頼インフラを構築することなく、既存のWebの仕組みを活用できます。

ただし、これはHTTPS/DNSに依存することを意味します。DNS乗っ取りやHTTPS証明書の不正発行が発生すれば、DIDも影響を受けます。

polkaでは、この技術的な限界を認識しつつ、現実的な選択としてdid:webを採用しています。

## DID Documentの構造

DID Documentは、JSON形式で記述されます。polkaで使用される典型的なDID Documentは以下のような構造を持ちます。

**verificationMethod**
公開鍵のリストです。各公開鍵には一意のIDが付けられます。

**assertionMethod**
署名検証に使用する鍵のリストです。`verificationMethod` で定義された鍵のIDを参照します。

**service**
polkaリポジトリのサービスエンドポイントです。クライアントは、このエンドポイントからデータブロックを取得します。

idは#polkaである必要があります。(例:did:web:example.com#polka)

## 複数鍵対応の仕組み

polkaは、複数の公開鍵をサポートしています。

### なぜ複数鍵が必要か

**鍵のローテーション**
秘密鍵が漏洩した可能性がある場合、新しい鍵に切り替える必要があります。複数鍵に対応していれば、古い鍵を無効化しながら新しい鍵を追加できます。

**複数デバイスでの運用**
デスクトップとモバイルで異なる鍵を使いたい場合、それぞれの鍵をDID Documentに登録できます。

### 検証の仕組み

クライアントがデータを検証する際、`assertionMethod` に含まれるいずれかの鍵で署名が検証できれば、そのデータを正当なものとして受け入れます。

すべての鍵で検証する必要はありません。1つでも検証に成功すれば十分です。

## DID解決の流れ

polkaでのDID解決は、以下の手順で行われます。

**1. DID DocumentのURL構築**
`did:web:example.com` というDIDから、`https://example.com/.well-known/did.json` というURLを構築します。

**2. HTTPS経由で取得**
構築したURLに HTTPSリクエストを送り、DID Documentを取得します。

**3. 公開鍵の抽出**
`verificationMethod` から公開鍵を抽出し、`assertionMethod` で参照されている鍵のリストを得ます。

**4. サービスエンドポイントの抽出**
`service` から、polkaリポジトリのサービスエンドポイントを抽出します。idが `#polka` のサービスを探します。

**5. データ取得と検証**
サービスエンドポイントからデータを取得し、抽出した公開鍵で署名を検証します。

## ドメイン変更時の同一性証明

did:webはドメイン名に依存していますが、公開鍵による同一性証明も可能です。

### ドメイン変更のシナリオ

たとえば、ユーザーが `example.com` から `example.net` にドメインを変更したとします。

新しいドメインの `.well-known/did.json` に、以前と同じ公開鍵を配置すれば、「公開鍵が同一 = 同一人物」であることを証明できます。
リポジトリのCommitオブジェクトにも使用しているdid:webが記録されるため、勝手に人の公開鍵を使うこともできません。

## 信頼の積み重ね

polkaでは、暗号学的な証明だけでなく、過去の発信の積み重ねそのものが信頼の根拠となると考えています。

### 電子署名だけでは不十分

電子署名により、データが改ざんされていないことは証明できます。しかし、それだけでは、そのデータを作成したのが「信頼できる人物」であるかは分かりません。

### 発信履歴による信頼

長期間にわたり一貫した発信を続けているアカウントは、短期間で作られたアカウントよりも信頼できると考えられます。

polkaでは、検証可能なデータの蓄積が、自然と信頼性の指標となることを期待しています。
